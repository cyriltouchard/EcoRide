<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API EcoRide</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .test {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
        }

        .error {
            border-left-color: #e74c3c;
        }

        .success {
            color: #27ae60;
            font-weight: bold;
        }

        .fail {
            color: #e74c3c;
            font-weight: bold;
        }

        button {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #219653;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üîß Diagnostic EcoRide</h1>

    <div id="results"></div>

    <h2>Tests manuels</h2>
    <button onclick="testLogin()">Test Connexion</button>
    <button onclick="testSearch()">Test Recherche</button>
    <button onclick="clearCache()">Vider Cache + Recharger</button>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        const results = document.getElementById('results');

        function log(title, success, data) {
            const div = document.createElement('div');
            div.className = 'test' + (success ? '' : ' error');
            div.innerHTML = `
                <h3>${success ? '‚úÖ' : '‚ùå'} ${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        // Tests automatiques au chargement
        window.addEventListener('DOMContentLoaded', async () => {
            // Test 1: Config
            log('Configuration', true, {
                'API_BASE': API_BASE,
                'Window Location': window.location.href,
                'Protocol': window.location.protocol,
                'Hostname': window.location.hostname,
                'Port': window.location.port
            });

            // Test 2: Sant√© backend
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                log('Backend Health', response.ok, { status: response.status, data });
            } catch (error) {
                log('Backend Health', false, { error: error.message });
            }

            // Test 3: Recherche vide
            try {
                const response = await fetch(`${API_BASE}/rides/search?`);
                const data = await response.json();
                log('Recherche (sans params)', response.ok, {
                    status: response.status,
                    count: data.count || data.rides?.length,
                    data: data.rides?.slice(0, 2) || data.data?.slice(0, 2)
                });
            } catch (error) {
                log('Recherche (sans params)', false, { error: error.message });
            }

            // Test 4: localStorage
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            log('LocalStorage', true, {
                'Token pr√©sent': !!token,
                'Token (d√©but)': token ? token.substring(0, 30) + '...' : null,
                'User pr√©sent': !!user,
                'User': user ? JSON.parse(user) : null
            });
        });

        async function testLogin() {
            try {
                const response = await fetch(`${API_BASE}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'final@ecoride.fr',
                        password: 'Test123!'
                    })
                });
                const data = await response.json();
                if (response.ok && data.data?.token) {
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data.user));
                }
                log('Test Connexion', response.ok, { status: response.status, data });
            } catch (error) {
                log('Test Connexion', false, { error: error.message });
            }
        }

        async function testSearch() {
            try {
                const response = await fetch(`${API_BASE}/rides/search?departure=Paris`);
                const data = await response.json();
                log('Test Recherche Paris', response.ok, {
                    status: response.status,
                    count: data.count || data.rides?.length,
                    rides: data.rides || data.data
                });
            } catch (error) {
                log('Test Recherche Paris', false, { error: error.message });
            }
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            alert('Cache localStorage et sessionStorage vid√©s. La page va se recharger.');
            location.reload(true);
        }
    </script>
</body>

</html>