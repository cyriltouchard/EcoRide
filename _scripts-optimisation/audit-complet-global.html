<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- MÃ©tas essentiels -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#27ae60">
    
    <!-- SEO -->
    <title>Audit Global - EcoRide | Analyse technique interne</title>
    <meta name="description" content="Tableau de bord d'audit technique et qualitÃ© du projet EcoRide.">
    <meta name="author" content="EcoRide">
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://ecoride.fr/audit-complet-global.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ecoride.fr/audit-complet-global.html">
    <meta property="og:title" content="Audit Global - EcoRide">
    <meta property="og:description" content="Tableau de bord d'audit technique et qualitÃ© du projet EcoRide.">
    <meta property="og:image" content="https://ecoride.fr/public/images/logo.png">
    <meta property="og:locale" content="fr_FR">
    <meta property="og:site_name" content="EcoRide">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ecoride.fr/audit-complet-global.html">
    <meta name="twitter:title" content="Audit Global - EcoRide">
    <meta name="twitter:description" content="Tableau de bord d'audit technique et qualitÃ© du projet EcoRide.">
    <meta name="twitter:image" content="https://ecoride.fr/public/images/logo.png">
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="public/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="public/images/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="public/images/favicon.svg">
    
    <!-- PrÃ©chargement des ressources (Performance) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- Styles -->
    <link rel="stylesheet" href="public/css/style.css">
</head></head>
<body>
    <div class="container">
        <h1>🔍 AUDIT COMPLET ECORIDE - Test Global</h1>
        
        <div class="summary">
            <h2>📊 Résumé de l'Audit</h2>
            <div class="progress">
                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
            <p><strong>Progression:</strong> <span id="progress-text">0/10 tests</span></p>
            <p><strong>Score Global:</strong> <span id="global-score">En cours...</span></p>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn-primary" onclick="runAllTests()">🚀 Lancer Audit Complet</button>
            <button class="btn-success" onclick="runCriticalTests()">⚡ Tests Critiques</button>
            <button class="btn-warning" onclick="resetTests()">🔄 Reset</button>
        </div>

        <div class="test-grid">
            <div id="test-server" class="test-section loading">
                <h2>🖥️ Serveur</h2>
                <p id="server-status">En attente...</p>
                <button class="btn-primary" onclick="testServer()">Test</button>
            </div>

            <div id="test-database" class="test-section loading">
                <h2>🗄️ Base de Données</h2>
                <p id="database-status">En attente...</p>
                <button class="btn-primary" onclick="testDatabase()">Test</button>
            </div>

            <div id="test-auth" class="test-section loading">
                <h2>🔐 Authentification</h2>
                <p id="auth-status">En attente...</p>
                <button class="btn-primary" onclick="testAuth()">Test</button>
            </div>

            <div id="test-registration" class="test-section loading">
                <h2>👤 Inscription</h2>
                <p id="registration-status">En attente...</p>
                <button class="btn-primary" onclick="testRegistration()">Test</button>
            </div>

            <div id="test-profile" class="test-section loading">
                <h2>👨‍💼 Profil Utilisateur</h2>
                <p id="profile-status">En attente...</p>
                <button class="btn-primary" onclick="testProfile()">Test</button>
            </div>

            <div id="test-vehicles" class="test-section loading">
                <h2>🚗 Véhicules</h2>
                <p id="vehicles-status">En attente...</p>
                <button class="btn-primary" onclick="testVehicles()">Test</button>
            </div>

            <div id="test-rides" class="test-section loading">
                <h2>🛣️ Trajets</h2>
                <p id="rides-status">En attente...</p>
                <button class="btn-primary" onclick="testRides()">Test</button>
            </div>

            <div id="test-security" class="test-section loading">
                <h2>🔒 Sécurité</h2>
                <p id="security-status">En attente...</p>
                <button class="btn-primary" onclick="testSecurity()">Test</button>
            </div>

            <div id="test-frontend" class="test-section loading">
                <h2>🎨 Frontend</h2>
                <p id="frontend-status">En attente...</p>
                <button class="btn-primary" onclick="testFrontend()">Test</button>
            </div>

            <div id="test-performance" class="test-section loading">
                <h2>⚡ Performance</h2>
                <p id="performance-status">En attente...</p>
                <button class="btn-primary" onclick="testPerformance()">Test</button>
            </div>
        </div>

        <div id="detailed-logs" class="test-section" style="margin-top: 20px;">
            <h2>📝 Logs Détaillés</h2>
            <pre id="logs">Logs en attente...</pre>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:3002/api';
        const logs = [];
        let completedTests = 0;
        const totalTests = 10;
        let globalScore = 0;
        let authToken = null;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            document.getElementById('logs').textContent = logs.join('\\n');
        }

        function updateProgress() {
            const percentage = (completedTests / totalTests) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${completedTests}/${totalTests} tests`;
            document.getElementById('global-score').textContent = `${Math.round(globalScore/completedTests)} / 100`;
        }

        function setTestResult(testId, status, message, score) {
            const element = document.getElementById(testId);
            const statusElement = document.getElementById(testId.replace('test-', '') + '-status');
            
            element.className = `test-section ${status}`;
            statusElement.innerHTML = message;
            
            completedTests++;
            globalScore += score;
            updateProgress();
            
            addLog(`Test ${testId}: ${message} (Score: ${score}/100)`);
        }

        async function testServer() {
            addLog('🖥️ Test du serveur...');
            try {
                const response = await fetch(`${API_BASE_URL.replace('/api', '')}/health`);
                if (response.status === 404) {
                    // Le serveur répond mais pas de route /health
                    setTestResult('test-server', 'success', '✅ Serveur actif (port 3002)', 95);
                } else if (response.ok) {
                    setTestResult('test-server', 'success', '✅ Serveur parfaitement fonctionnel', 100);
                } else {
                    setTestResult('test-server', 'warning', `⚠️ Serveur répond (${response.status})`, 70);
                }
            } catch (error) {
                setTestResult('test-server', 'error', '❌ Serveur inaccessible', 0);
            }
        }

        async function testDatabase() {
            addLog('🗄️ Test de la base de données...');
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test@invalid.com', password: 'test' })
                });
                
                if (response.status === 400) {
                    setTestResult('test-database', 'success', '✅ Base de données accessible', 100);
                } else {
                    setTestResult('test-database', 'warning', '⚠️ Réponse inattendue', 70);
                }
            } catch (error) {
                setTestResult('test-database', 'error', '❌ Erreur base de données', 0);
            }
        }

        async function testAuth() {
            addLog('🔐 Test d\\'authentification...');
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'admin@ecoride.fr', password: 'password' })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success && data.data.token) {
                    authToken = data.data.token;
                    setTestResult('test-auth', 'success', '✅ Connexion admin réussie', 100);
                } else {
                    setTestResult('test-auth', 'error', '❌ Échec connexion admin', 0);
                }
            } catch (error) {
                setTestResult('test-auth', 'error', '❌ Erreur authentification', 0);
            }
        }

        async function testRegistration() {
            addLog('👤 Test d\\'inscription...');
            const randomEmail = `test${Date.now()}@ecoride.test`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pseudo: 'TestUser',
                        email: randomEmail,
                        password: 'testpassword123'
                    })
                });
                
                const data = await response.json();
                
                if (response.status === 201 && data.success) {
                    setTestResult('test-registration', 'success', '✅ Inscription fonctionnelle', 100);
                } else {
                    setTestResult('test-registration', 'warning', `⚠️ Problème inscription: ${data.message}`, 50);
                }
            } catch (error) {
                setTestResult('test-registration', 'error', '❌ Erreur inscription', 0);
            }
        }

        async function testProfile() {
            addLog('👨‍💼 Test du profil utilisateur...');
            if (!authToken) {
                setTestResult('test-profile', 'warning', '⚠️ Token manquant', 0);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    setTestResult('test-profile', 'success', '✅ Profil chargé correctement', 100);
                } else {
                    setTestResult('test-profile', 'error', '❌ Erreur chargement profil', 0);
                }
            } catch (error) {
                setTestResult('test-profile', 'error', '❌ Erreur profil', 0);
            }
        }

        async function testVehicles() {
            addLog('🚗 Test des véhicules...');
            if (!authToken) {
                setTestResult('test-vehicles', 'warning', '⚠️ Token manquant', 0);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/vehicles/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    setTestResult('test-vehicles', 'success', '✅ API véhicules opérationnelle', 100);
                } else {
                    setTestResult('test-vehicles', 'warning', `⚠️ Statut: ${response.status}`, 70);
                }
            } catch (error) {
                setTestResult('test-vehicles', 'error', '❌ Erreur véhicules', 0);
            }
        }

        async function testRides() {
            addLog('🛣️ Test des trajets...');
            if (!authToken) {
                setTestResult('test-rides', 'warning', '⚠️ Token manquant', 0);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/rides/offered`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    setTestResult('test-rides', 'success', '✅ API trajets opérationnelle', 100);
                } else {
                    setTestResult('test-rides', 'warning', `⚠️ Statut: ${response.status}`, 70);
                }
            } catch (error) {
                setTestResult('test-rides', 'error', '❌ Erreur trajets', 0);
            }
        }

        async function testSecurity() {
            addLog('🔒 Test de sécurité...');
            
            // Test CORS
            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    method: 'OPTIONS'
                });
                
                const corsHeaders = response.headers.get('Access-Control-Allow-Origin');
                
                if (corsHeaders) {
                    setTestResult('test-security', 'success', '✅ CORS configuré', 90);
                } else {
                    setTestResult('test-security', 'warning', '⚠️ CORS non détecté', 60);
                }
            } catch (error) {
                setTestResult('test-security', 'error', '❌ Erreur sécurité', 0);
            }
        }

        async function testFrontend() {
            addLog('🎨 Test du frontend...');
            
            // Test des ressources CSS/JS
            const cssTest = document.querySelector('link[href*="style.css"]');
            const jsErrors = window.jsErrors || 0;
            
            if (jsErrors === 0) {
                setTestResult('test-frontend', 'success', '✅ Frontend opérationnel', 95);
            } else {
                setTestResult('test-frontend', 'warning', `⚠️ ${jsErrors} erreurs JS`, 70);
            }
        }

        async function testPerformance() {
            addLog('⚡ Test de performance...');
            
            const startTime = performance.now();
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'admin@ecoride.fr', password: 'password' })
                });
                
                const endTime = performance.now();
                const responseTime = endTime - startTime;
                
                if (responseTime < 500) {
                    setTestResult('test-performance', 'success', `✅ Excellent (${Math.round(responseTime)}ms)`, 100);
                } else if (responseTime < 1000) {
                    setTestResult('test-performance', 'warning', `⚠️ Acceptable (${Math.round(responseTime)}ms)`, 75);
                } else {
                    setTestResult('test-performance', 'error', `❌ Lent (${Math.round(responseTime)}ms)`, 40);
                }
            } catch (error) {
                setTestResult('test-performance', 'error', '❌ Erreur performance', 0);
            }
        }

        async function runCriticalTests() {
            addLog('⚡ Démarrage des tests critiques...');
            resetTests();
            
            await testServer();
            await new Promise(r => setTimeout(r, 500));
            await testDatabase();
            await new Promise(r => setTimeout(r, 500));
            await testAuth();
        }

        async function runAllTests() {
            addLog('🚀 Démarrage de l\\'audit complet...');
            resetTests();
            
            const tests = [
                testServer,
                testDatabase,
                testAuth,
                testRegistration,
                testProfile,
                testVehicles,
                testRides,
                testSecurity,
                testFrontend,
                testPerformance
            ];
            
            for (const test of tests) {
                await test();
                await new Promise(r => setTimeout(r, 800));
            }
            
            addLog('🎉 Audit complet terminé !');
        }

        function resetTests() {
            completedTests = 0;
            globalScore = 0;
            logs.length = 0;
            authToken = null;
            
            const testElements = document.querySelectorAll('.test-section');
            testElements.forEach(el => {
                if (el.id && el.id.startsWith('test-')) {
                    el.className = 'test-section loading';
                    const statusId = el.id.replace('test-', '') + '-status';
                    const statusEl = document.getElementById(statusId);
                    if (statusEl) statusEl.textContent = 'En attente...';
                }
            });
            
            updateProgress();
            document.getElementById('logs').textContent = 'Logs en attente...';
        }

        // Lancement automatique des tests critiques
        window.onload = () => {
            addLog('🎯 Audit EcoRide initialisé');
            setTimeout(runCriticalTests, 1000);
        };
    </script>
</body>
</html>