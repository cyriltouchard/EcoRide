<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- MÃ©tas essentiels -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#27ae60">
    
    <!-- SEO -->
    <title>Espace Chauffeur - EcoRide | GÃ©rez vos trajets proposÃ©s</title>
    <meta name="description" content="AccÃ©dez Ã  votre espace chauffeur EcoRide. GÃ©rez vos trajets publiÃ©s, suivez vos rÃ©servations, communiquez avec vos passagers et consultez vos gains.">
    <meta name="author" content="EcoRide">
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://ecoride.fr/espace-chauffeur.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ecoride.fr/espace-chauffeur.html">
    <meta property="og:title" content="Espace Chauffeur - EcoRide">
    <meta property="og:description" content="AccÃ©dez Ã  votre espace chauffeur EcoRide. GÃ©rez vos trajets publiÃ©s, suivez vos rÃ©servations, communiquez avec vos passagers et consultez vos ...">
    <meta property="og:image" content="https://ecoride.fr/public/images/logo.png">
    <meta property="og:locale" content="fr_FR">
    <meta property="og:site_name" content="EcoRide">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://ecoride.fr/espace-chauffeur.html">
    <meta name="twitter:title" content="Espace Chauffeur - EcoRide">
    <meta name="twitter:description" content="AccÃ©dez Ã  votre espace chauffeur EcoRide. GÃ©rez vos trajets publiÃ©s, suivez vos rÃ©servations, communiquez avec vos passagers et consultez vos ...">
    <meta name="twitter:image" content="https://ecoride.fr/public/images/logo.png">
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="public/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="public/images/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="public/images/favicon.svg">
    
    <!-- PrÃ©chargement des ressources (Performance) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- Styles -->
    <link rel="stylesheet" href="public/css/style.css">
</head></head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="public/images/logo.png" alt="EcoRide" class="logo">
                <span>EcoRide</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="covoiturages.html">Rechercher</a></li>
                <li><a href="espace-chauffeur.html" class="active">Espace Chauffeur</a></li>
                <li><a href="espace-utilisateur.html">Mon Compte</a></li>
                <li><a href="#" onclick="logout()">Déconnexion</a></li>
            </ul>
        </div>
    </nav>

    <main class="dashboard-container">
        <!-- En-tête du tableau de bord -->
        <div class="dashboard-header">
            <h1>🚗 Espace Chauffeur EcoRide</h1>
            <p>Gérez vos véhicules et créez vos covoiturages</p>
            <div id="user-info" class="user-info">
                <span id="driver-name">Chargement...</span> | 
                <span id="credit-balance">💰 -- crédits</span>
            </div>
        </div>

        <!-- Actions rapides -->
        <div class="quick-actions">
            <button class="btn btn-success" onclick="showAddVehicleModal()">
                🚙 Ajouter un véhicule
            </button>
            <button class="btn btn-primary" onclick="showCreateRideModal()">
                ➕ Créer un covoiturage
            </button>
            <button class="btn btn-warning" onclick="showPreferencesModal()">
                ⚙️ Mes préférences
            </button>
        </div>

        <!-- Statistiques -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-vehicles">0</div>
                <div>Véhicules enregistrés</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-rides">0</div>
                <div>Trajets actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-passengers">0</div>
                <div>Passagers transportés</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="eco-score">0</div>
                <div>Score écologique</div>
            </div>
        </div>

        <!-- Sections principales -->
        <div class="dashboard-sections">
            <!-- Gestion des véhicules (US8) -->
            <div class="section-card">
                <div class="section-header">
                    🚗 Mes Véhicules (US8)
                </div>
                <div class="section-content">
                    <div id="vehicles-container">
                        <div class="empty-state">
                            <i>🚗</i>
                            <p>Aucun véhicule enregistré</p>
                            <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                Ajouter votre premier véhicule
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gestion des trajets (US9) -->
            <div class="section-card">
                <div class="section-header">
                    🛣️ Mes Covoiturages (US9)
                </div>
                <div class="section-content">
                    <div id="rides-container">
                        <div class="empty-state">
                            <i>🛣️</i>
                            <p>Aucun covoiturage créé</p>
                            <button class="btn btn-primary" onclick="showCreateRideModal()">
                                Créer votre premier trajet
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profil chauffeur -->
        <div class="section-card" style="margin-top: 30px;">
            <div class="section-header">
                👤 Mon Profil Chauffeur
            </div>
            <div class="section-content">
                <div class="driver-profile" id="driver-profile">
                    <h4>Préférences de conduite</h4>
                    <div class="preferences-grid" id="preferences-grid">
                        <!-- Préférences chargées dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Ajouter Véhicule -->
    <div id="add-vehicle-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🚗 Ajouter un véhicule</h3>
                <span class="close" onclick="closeModal('add-vehicle-modal')">&times;</span>
            </div>
            <form id="add-vehicle-form">
                <div class="form-group">
                    <label for="vehicle-brand">Marque *</label>
                    <input type="text" id="vehicle-brand" required placeholder="Ex: Renault">
                </div>
                
                <div class="form-group">
                    <label for="vehicle-model">Modèle *</label>
                    <input type="text" id="vehicle-model" required placeholder="Ex: Clio">
                </div>
                
                <div class="form-group">
                    <label for="vehicle-year">Année</label>
                    <input type="number" id="vehicle-year" min="1990" max="2024" placeholder="2020">
                </div>
                
                <div class="form-group">
                    <label for="vehicle-energy">Type d'énergie *</label>
                    <select id="vehicle-energy" required>
                        <option value="">Sélectionnez...</option>
                        <option value="electric">🔋 Électrique</option>
                        <option value="hybrid">⚡ Hybride</option>
                        <option value="gasoline">⛽ Essence</option>
                        <option value="diesel">🛢️ Diesel</option>
                        <option value="gpl">🔥 GPL</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="vehicle-seats">Nombre de places *</label>
                    <select id="vehicle-seats" required>
                        <option value="">Sélectionnez...</option>
                        <option value="2">2 places</option>
                        <option value="4">4 places</option>
                        <option value="5">5 places</option>
                        <option value="7">7 places</option>
                        <option value="9">9 places</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="vehicle-color">Couleur</label>
                    <input type="text" id="vehicle-color" placeholder="Ex: Bleu">
                </div>
                
                <div class="form-group">
                    <label for="vehicle-plate">Plaque d'immatriculation</label>
                    <input type="text" id="vehicle-plate" placeholder="Ex: AB-123-CD">
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Ajouter le véhicule</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-vehicle-modal')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Créer Covoiturage -->
    <div id="create-ride-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>➕ Créer un covoiturage</h3>
                <span class="close" onclick="closeModal('create-ride-modal')">&times;</span>
            </div>
            <form id="create-ride-form">
                <div class="form-group">
                    <label for="ride-vehicle">Véhicule *</label>
                    <select id="ride-vehicle" required>
                        <option value="">Sélectionnez un véhicule...</option>
                        <!-- Options chargées dynamiquement -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ride-departure">Ville de départ *</label>
                    <input type="text" id="ride-departure" required placeholder="Ex: Paris">
                </div>
                
                <div class="form-group">
                    <label for="ride-arrival">Ville d'arrivée *</label>
                    <input type="text" id="ride-arrival" required placeholder="Ex: Lyon">
                </div>
                
                <div class="form-group">
                    <label for="ride-date">Date du trajet *</label>
                    <input type="date" id="ride-date" required>
                </div>
                
                <div class="form-group">
                    <label for="ride-time">Heure de départ *</label>
                    <input type="time" id="ride-time" required>
                </div>
                
                <div class="form-group">
                    <label for="ride-seats">Places disponibles *</label>
                    <select id="ride-seats" required>
                        <option value="">Sélectionnez...</option>
                        <option value="1">1 place</option>
                        <option value="2">2 places</option>
                        <option value="3">3 places</option>
                        <option value="4">4 places</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ride-price">Prix par passager (€) *</label>
                    <input type="number" id="ride-price" min="1" step="0.5" required placeholder="15.00">
                    <small>💡 Commission EcoRide : 2 crédits par trajet</small>
                </div>
                
                <div class="form-group">
                    <label for="ride-description">Description (optionnel)</label>
                    <textarea id="ride-description" rows="3" placeholder="Informations supplémentaires..."></textarea>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Créer le covoiturage</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('create-ride-modal')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Préférences -->
    <div id="preferences-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ Mes préférences de conduite</h3>
                <span class="close" onclick="closeModal('preferences-modal')">&times;</span>
            </div>
            <form id="preferences-form">
                <div class="form-group">
                    <label for="pref-smoking">Autoriser les fumeurs ?</label>
                    <select id="pref-smoking">
                        <option value="no">🚭 Non-fumeur uniquement</option>
                        <option value="yes">🚬 Fumeurs acceptés</option>
                        <option value="outside">🌬️ Pause fumeur possible</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pref-pets">Autoriser les animaux ?</label>
                    <select id="pref-pets">
                        <option value="no">🚫 Pas d'animaux</option>
                        <option value="small">🐕 Petits animaux seulement</option>
                        <option value="yes">🐾 Tous animaux acceptés</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pref-conversation">Niveau de conversation</label>
                    <select id="pref-conversation">
                        <option value="quiet">🤫 Trajet silencieux</option>
                        <option value="moderate">💬 Conversation modérée</option>
                        <option value="talkative">🗣️ J'aime discuter</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pref-music">Musique pendant le trajet</label>
                    <select id="pref-music">
                        <option value="no">🔇 Pas de musique</option>
                        <option value="soft">🎵 Musique douce</option>
                        <option value="choice">🎶 Au choix des passagers</option>
                        <option value="driver">🎸 Ma playlist</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Sauvegarder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('preferences-modal')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <script src="public/js/script.js"></script>
    <script>
        // Variables globales
        let currentUser = null;
        let vehicles = [];
        let rides = [];

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadDriverData();
            
            // Configuration de la date minimum pour les trajets
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ride-date').min = today;
        });

        // Vérification de l'authentification
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !user.id) {
                alert('Vous devez être connecté pour accéder à cette page.');
                window.location.href = 'connexion.html';
                return;
            }
            
            // Vérifier si l'utilisateur est un chauffeur
            if (user.role !== 'driver' && user.role !== 'admin') {
                alert('Accès réservé aux chauffeurs. Veuillez vous inscrire comme chauffeur.');
                window.location.href = 'espace-utilisateur.html';
                return;
            }
            
            currentUser = user;
            updateUserInfo();
        }

        // Mise à jour des informations utilisateur
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('driver-name').textContent = currentUser.name || 'Chauffeur';
                loadCreditBalance();
            }
        }

        // Chargement du solde de crédits
        async function loadCreditBalance() {
            try {
                const response = await window.fetchWithAuth(window.getApiUrl('/credits/balance'));
                
                if (response.ok) {
                    const data = await response.json();
                    const credits = data.data ? data.data.current_credits : data.current_credits;
                    document.getElementById('credit-balance').textContent = `💰 ${credits} crédits`;
                } else {
                    console.error('Erreur chargement crédits:', response.status);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des crédits:', error);
            }
        }

        // Chargement des données du chauffeur
        async function loadDriverData() {
            await Promise.all([
                loadVehicles(),
                loadRides(),
                loadDriverPreferences(),
                loadStatistics()
            ]);
        }

        // Chargement des véhicules
        async function loadVehicles() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vehicles/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    vehicles = await response.json();
                    displayVehicles();
                    updateVehicleOptions();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des véhicules:', error);
            }
        }

        // Affichage des véhicules
        function displayVehicles() {
            const container = document.getElementById('vehicles-container');
            
            if (vehicles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>🚗</i>
                        <p>Aucun véhicule enregistré</p>
                        <button class="btn btn-primary" onclick="showAddVehicleModal()">
                            Ajouter votre premier véhicule
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = vehicles.map(vehicle => `
                <div class="vehicle-item">
                    <div class="vehicle-header">
                        <h4>${vehicle.brand} ${vehicle.model} ${vehicle.year || ''}</h4>
                        <span class="eco-badge">${getEnergyEmoji(vehicle.energy_type)} ${getEnergyLabel(vehicle.energy_type)}</span>
                    </div>
                    <p>
                        🪑 ${vehicle.seats} places | 
                        🎨 ${vehicle.color || 'N/A'} | 
                        🔢 ${vehicle.license_plate || 'N/A'}
                    </p>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="editVehicle(${vehicle.id})">Modifier</button>
                        <button class="btn btn-danger" onclick="deleteVehicle(${vehicle.id})">Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        // Chargement des trajets
        async function loadRides() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/rides/my-rides', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    rides = await response.json();
                    displayRides();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des trajets:', error);
            }
        }

        // Affichage des trajets
        function displayRides() {
            const container = document.getElementById('rides-container');
            
            if (rides.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>🛣️</i>
                        <p>Aucun covoiturage créé</p>
                        <button class="btn btn-primary" onclick="showCreateRideModal()">
                            Créer votre premier trajet
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = rides.map(ride => `
                <div class="ride-item">
                    <div class="ride-header">
                        <h4>${ride.departure_city} → ${ride.arrival_city}</h4>
                        <span class="status-badge status-${ride.status}">${getStatusLabel(ride.status)}</span>
                    </div>
                    <p>
                        📅 ${formatDate(ride.departure_date)} à ${ride.departure_time} | 
                        💰 ${ride.price_per_passenger}€ | 
                        🪑 ${ride.available_seats}/${ride.total_seats} places
                    </p>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="viewRideDetails(${ride.id})">Détails</button>
                        ${ride.status === 'active' ? `
                            <button class="btn btn-warning" onclick="updateRideStatus(${ride.id}, 'started')">Démarrer</button>
                            <button class="btn btn-danger" onclick="cancelRide(${ride.id})">Annuler</button>
                        ` : ''}
                        ${ride.status === 'started' ? `
                            <button class="btn btn-success" onclick="updateRideStatus(${ride.id}, 'completed')">Terminer</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Chargement des préférences chauffeur
        async function loadDriverPreferences() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vehicles/driver-preferences', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const preferences = await response.json();
                    displayDriverPreferences(preferences);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des préférences:', error);
            }
        }

        // Affichage des préférences
        function displayDriverPreferences(preferences) {
            const container = document.getElementById('preferences-grid');
            
            if (!preferences || Object.keys(preferences).length === 0) {
                container.innerHTML = `
                    <div class="preference-item">
                        <p>Aucune préférence définie</p>
                        <button class="btn btn-primary" onclick="showPreferencesModal()">Définir mes préférences</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="preference-item">
                    <strong>🚭 Fumeurs</strong>
                    <p>${getPreferenceLabel('smoking', preferences.smoking_allowed)}</p>
                </div>
                <div class="preference-item">
                    <strong>🐾 Animaux</strong>
                    <p>${getPreferenceLabel('pets', preferences.pets_allowed)}</p>
                </div>
                <div class="preference-item">
                    <strong>💬 Conversation</strong>
                    <p>${getPreferenceLabel('conversation', preferences.conversation_level)}</p>
                </div>
                <div class="preference-item">
                    <strong>🎵 Musique</strong>
                    <p>${getPreferenceLabel('music', preferences.music_preference)}</p>
                </div>
            `;
        }

        // Chargement des statistiques
        async function loadStatistics() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/rides/statistics', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    updateStatistics(stats);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
                // Affichage des statistiques locales
                updateStatistics({
                    totalVehicles: vehicles.length,
                    activeRides: rides.filter(r => r.status === 'active').length,
                    totalPassengers: 0,
                    ecoScore: calculateEcoScore()
                });
            }
        }

        // Mise à jour des statistiques
        function updateStatistics(stats) {
            document.getElementById('total-vehicles').textContent = stats.totalVehicles || vehicles.length;
            document.getElementById('active-rides').textContent = stats.activeRides || rides.filter(r => r.status === 'active').length;
            document.getElementById('total-passengers').textContent = stats.totalPassengers || 0;
            document.getElementById('eco-score').textContent = stats.ecoScore || calculateEcoScore();
        }

        // Calcul du score écologique
        function calculateEcoScore() {
            const ecoPoints = vehicles.reduce((total, vehicle) => {
                const points = {
                    'electric': 100,
                    'hybrid': 80,
                    'gpl': 60,
                    'gasoline': 40,
                    'diesel': 30
                };
                return total + (points[vehicle.energy_type] || 0);
            }, 0);
            
            return Math.round(ecoPoints / Math.max(vehicles.length, 1));
        }

        // Gestion des modaux
        function showAddVehicleModal() {
            document.getElementById('add-vehicle-modal').style.display = 'block';
        }

        function showCreateRideModal() {
            document.getElementById('create-ride-modal').style.display = 'block';
        }

        function showPreferencesModal() {
            document.getElementById('preferences-modal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Gestion des formulaires
        document.getElementById('add-vehicle-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const vehicleData = {
                brand: document.getElementById('vehicle-brand').value,
                model: document.getElementById('vehicle-model').value,
                year: document.getElementById('vehicle-year').value || null,
                energy_type: document.getElementById('vehicle-energy').value,
                seats: parseInt(document.getElementById('vehicle-seats').value),
                color: document.getElementById('vehicle-color').value || null,
                license_plate: document.getElementById('vehicle-plate').value || null
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vehicles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(vehicleData)
                });
                
                if (response.ok) {
                    alert('Véhicule ajouté avec succès !');
                    closeModal('add-vehicle-modal');
                    document.getElementById('add-vehicle-form').reset();
                    loadVehicles();
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'ajout du véhicule');
            }
        });

        document.getElementById('create-ride-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rideData = {
                vehicle_id: parseInt(document.getElementById('ride-vehicle').value),
                departure_city: document.getElementById('ride-departure').value,
                arrival_city: document.getElementById('ride-arrival').value,
                departure_date: document.getElementById('ride-date').value,
                departure_time: document.getElementById('ride-time').value,
                available_seats: parseInt(document.getElementById('ride-seats').value),
                price_per_passenger: parseFloat(document.getElementById('ride-price').value),
                description: document.getElementById('ride-description').value || null
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/rides', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(rideData)
                });
                
                if (response.ok) {
                    alert('Covoiturage créé avec succès !');
                    closeModal('create-ride-modal');
                    document.getElementById('create-ride-form').reset();
                    loadRides();
                    loadCreditBalance(); // Recharger le solde de crédits
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la création du covoiturage');
            }
        });

        document.getElementById('preferences-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const preferencesData = {
                smoking_allowed: document.getElementById('pref-smoking').value,
                pets_allowed: document.getElementById('pref-pets').value,
                conversation_level: document.getElementById('pref-conversation').value,
                music_preference: document.getElementById('pref-music').value
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vehicles/driver-preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(preferencesData)
                });
                
                if (response.ok) {
                    alert('Préférences sauvegardées avec succès !');
                    closeModal('preferences-modal');
                    loadDriverPreferences();
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la sauvegarde des préférences');
            }
        });

        // Fonctions utilitaires
        function updateVehicleOptions() {
            const select = document.getElementById('ride-vehicle');
            select.innerHTML = '<option value="">Sélectionnez un véhicule...</option>';
            
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.brand} ${vehicle.model} (${vehicle.seats} places)`;
                select.appendChild(option);
            });
        }

        function getEnergyEmoji(energyType) {
            const emojis = {
                'electric': '🔋',
                'hybrid': '⚡',
                'gasoline': '⛽',
                'diesel': '🛢️',
                'gpl': '🔥'
            };
            return emojis[energyType] || '🚗';
        }

        function getEnergyLabel(energyType) {
            const labels = {
                'electric': 'Électrique',
                'hybrid': 'Hybride',
                'gasoline': 'Essence',
                'diesel': 'Diesel',
                'gpl': 'GPL'
            };
            return labels[energyType] || energyType;
        }

        function getStatusLabel(status) {
            const labels = {
                'active': 'Actif',
                'started': 'En cours',
                'completed': 'Terminé',
                'cancelled': 'Annulé'
            };
            return labels[status] || status;
        }

        function getPreferenceLabel(type, value) {
            const labels = {
                smoking: {
                    'no': '🚭 Non-fumeur',
                    'yes': '🚬 Accepté',
                    'outside': '🌬️ Pause possible'
                },
                pets: {
                    'no': '🚫 Interdits',
                    'small': '🐕 Petits seulement',
                    'yes': '🐾 Acceptés'
                },
                conversation: {
                    'quiet': '🤫 Silencieux',
                    'moderate': '💬 Modéré',
                    'talkative': '🗣️ Bavard'
                },
                music: {
                    'no': '🔇 Pas de musique',
                    'soft': '🎵 Douce',
                    'choice': '🎶 Au choix',
                    'driver': '🎸 Ma playlist'
                }
            };
            return labels[type]?.[value] || value;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        // Actions sur les véhicules et trajets
        async function deleteVehicle(vehicleId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce véhicule ?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vehicles/${vehicleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Véhicule supprimé avec succès !');
                    loadVehicles();
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression du véhicule');
            }
        }

        async function cancelRide(rideId) {
            if (!confirm('Êtes-vous sûr de vouloir annuler ce trajet ?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/rides/${rideId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Trajet annulé avec succès !');
                    loadRides();
                    loadCreditBalance(); // Recharger le solde
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'annulation du trajet');
            }
        }

        async function updateRideStatus(rideId, newStatus) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/rides/${rideId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    alert('Statut mis à jour avec succès !');
                    loadRides();
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la mise à jour du statut');
            }
        }

        function viewRideDetails(rideId) {
            window.location.href = `details-covoiturage.html?id=${rideId}`;
        }

        function editVehicle(vehicleId) {
            // TODO: Implémenter la modification de véhicule
            alert('Fonctionnalité de modification en cours de développement');
        }

        // Fermer les modaux en cliquant à l'extérieur
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // Déconnexion
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>