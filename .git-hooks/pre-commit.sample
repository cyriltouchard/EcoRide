#!/bin/sh
# Git pre-commit hook pour v√©rifier la s√©curit√© avant chaque commit
# Installation: cp pre-commit.sample .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "üîê V√©rification de s√©curit√© avant commit..."

# Couleurs pour le terminal
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# V√©rifier que nous sommes dans le bon r√©pertoire
if [ ! -d "server" ]; then
    echo "${YELLOW}‚ö†Ô∏è  Impossible de trouver le dossier 'server', hook ignor√©${NC}"
    exit 0
fi

# V√©rifier que node est install√©
if ! command -v node &> /dev/null; then
    echo "${YELLOW}‚ö†Ô∏è  Node.js non trouv√©, v√©rification de s√©curit√© ignor√©e${NC}"
    exit 0
fi

# V√©rifier que les modules sont install√©s
if [ ! -d "server/node_modules" ]; then
    echo "${YELLOW}‚ö†Ô∏è  Modules npm non install√©s, v√©rification de s√©curit√© ignor√©e${NC}"
    exit 0
fi

# 1. V√©rifier qu'aucun fichier .env n'est commit√©
echo "üìã V√©rification des fichiers sensibles..."
if git diff --cached --name-only | grep -E "^\.env$|\.env\.local$|\.env\.production$"; then
    echo "${RED}‚ùå ERREUR: Tentative de commit d'un fichier .env !${NC}"
    echo "${RED}   Les fichiers .env contiennent des secrets et ne doivent JAMAIS √™tre commit√©s.${NC}"
    echo ""
    echo "Pour corriger:"
    echo "  git reset HEAD .env"
    echo "  git reset HEAD .env.local"
    echo ""
    exit 1
fi

# 2. V√©rifier qu'aucun fichier de backup n'est commit√©
if git diff --cached --name-only | grep -E "\.bak$|\.backup$|~$"; then
    echo "${YELLOW}‚ö†Ô∏è  Fichiers de backup d√©tect√©s, ils ne devraient g√©n√©ralement pas √™tre commit√©s${NC}"
fi

# 3. Ex√©cuter le scan de s√©curit√©
echo "üîç Scan des secrets hardcod√©s..."
cd server
if node security-check.js; then
    echo "${GREEN}‚úÖ Aucun secret hardcod√© d√©tect√©${NC}"
    cd ..
else
    echo "${RED}‚ùå ERREUR: Secrets hardcod√©s d√©tect√©s !${NC}"
    echo "${RED}   Corrigez les probl√®mes avant de commiter.${NC}"
    echo ""
    echo "Pour voir les d√©tails:"
    echo "  cd server && npm run security-check"
    echo ""
    cd ..
    exit 1
fi

# 4. V√©rifier les fichiers JavaScript modifi√©s pour des patterns dangereux
echo "üîç V√©rification des patterns dangereux..."
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.js$")

if [ -n "$STAGED_JS_FILES" ]; then
    # V√©rifier console.log avec des donn√©es sensibles potentielles
    if echo "$STAGED_JS_FILES" | xargs grep -n "console.log.*password\|console.log.*token\|console.log.*secret" 2>/dev/null; then
        echo "${YELLOW}‚ö†Ô∏è  ATTENTION: console.log avec des donn√©es potentiellement sensibles d√©tect√©${NC}"
        echo "${YELLOW}   Assurez-vous de ne pas logger de secrets en production${NC}"
    fi
    
    # V√©rifier eval() qui est dangereux
    if echo "$STAGED_JS_FILES" | xargs grep -n "eval(" 2>/dev/null; then
        echo "${YELLOW}‚ö†Ô∏è  ATTENTION: Utilisation de eval() d√©tect√©e (risque de s√©curit√©)${NC}"
    fi
fi

echo "${GREEN}‚úÖ Toutes les v√©rifications de s√©curit√© sont pass√©es !${NC}"
echo ""
exit 0
